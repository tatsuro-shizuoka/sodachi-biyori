generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model School {
  id               String           @id @default(cuid())
  slug             String           @unique
  name             String
  adminMemo        String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  enableReactions  Boolean          @default(true)
  enableStampCard  Boolean          @default(true)
  enableAiAnalysis Boolean          @default(false)
  popDisplayMode   String           @default("priority")
  analyticsEvents  AnalyticsEvent[]
  categories       Category[]
  classes          Class[]
  midrollAds       MidrollAd[]
  prerollAds       PrerollAd[]
  sponsors         Sponsor[]
  announcements    Announcement[]
}

model Class {
  id               String                     @id @default(uuid())
  name             String
  slug             String?
  grade            String?
  schoolYear       String?
  password         String
  adminMemo        String?
  schoolId         String?
  isArchived       Boolean                    @default(false)
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  analyticsEvents  AnalyticsEvent[]
  children         ChildClassroom[]
  school           School?                    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  guardianSettings GuardianClassroomSetting[]
  videos           Video[]

  @@unique([schoolId, slug])
}

model Video {
  id             String         @id @default(uuid())
  title          String
  description    String?
  videoUrl       String
  vimeoVideoId   String?
  thumbnailUrl   String?
  status         String         @default("draft")
  recordedOn     DateTime?
  durationSec    Int?
  adminMemo      String?
  isDownloadable Boolean        @default(false)
  isAllClasses   Boolean        @default(false)
  categoryId     String?
  startAt        DateTime?
  endAt          DateTime?
  classId        String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  analysisStatus String?        @default("pending")
  favorites      Favorite[]
  reactions      ReactionLog[]
  category       Category?      @relation(fields: [categoryId], references: [id])
  class          Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  faceTags       VideoFaceTag[]
  views          VideoView[]
}

model VideoView {
  id          String    @id @default(uuid())
  videoId     String
  guardianId  String?
  viewedAt    DateTime  @default(now())
  durationSec Int?
  deviceType  String?
  guardian    Guardian? @relation(fields: [guardianId], references: [id])
  video       Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([guardianId])
}

model ReactionLog {
  id         String    @id @default(uuid())
  videoId    String
  type       String
  guardianId String?
  createdAt  DateTime  @default(now())
  guardian   Guardian? @relation(fields: [guardianId], references: [id])
  video      Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
}

model StampCard {
  id            String   @id @default(uuid())
  guardianId    String
  year          Int
  stamps        String
  lastStampedAt DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  guardian      Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([guardianId, year])
}

model Sponsor {
  id               String              @id @default(uuid())
  name             String
  imageUrl         String?
  linkUrl          String?
  position         String              @default("footer")
  isActive         Boolean             @default(true)
  priority         Int                 @default(0)
  ctaText          String?
  videoUrl         String?
  displayStyle     String              @default("banner")
  displayFrequency String              @default("always")
  contentType      String              @default("image")
  validFrom        DateTime?
  validTo          DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  schoolId         String?
  midrollAds       MidrollAd[]
  prerollAds       PrerollAd[]
  school           School?             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  clicks           SponsorClick[]
  impressions      SponsorImpression[]
  supports         SponsorSupport[]

  @@index([schoolId])
}

model SponsorImpression {
  id        String   @id @default(uuid())
  sponsorId String
  schoolId  String?
  createdAt DateTime @default(now())
  sponsor   Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
  @@index([schoolId])
}

model SponsorClick {
  id        String   @id @default(uuid())
  sponsorId String
  schoolId  String?
  createdAt DateTime @default(now())
  sponsor   Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
  @@index([schoolId])
}

model SponsorSupport {
  id            String   @id @default(uuid())
  sponsorId     String?
  schoolId      String?
  guardianId    String?
  amount        Int?
  status        String   @default("pending")
  paymentMethod String?
  paymentId     String?
  createdAt     DateTime @default(now())
  sponsor       Sponsor? @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
  @@index([schoolId])
  @@index([guardianId])
}

model Category {
  id        String   @id @default(uuid())
  name      String
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  videos    Video[]
}

model Guardian {
  id              String                     @id @default(uuid())
  name            String
  email           String                     @unique
  passwordHash    String
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  analyticsEvents AnalyticsEvent[]
  deviceTokens    DeviceToken[]
  favorites       Favorite[]
  children        GuardianChild[]
  notifSettings   GuardianClassroomSetting[]
  reactionLogs    ReactionLog[]
  stampCards      StampCard[]
  videoViews      VideoView[]
}

model Child {
  id               String           @id @default(uuid())
  name             String
  birthday         DateTime?
  faceId           String?
  faceImageUrl     String?
  faceRegisteredAt DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  classes          ChildClassroom[]
  faces            ChildFace[]
  guardians        GuardianChild[]
  faceTags         VideoFaceTag[]
}

model ChildFace {
  id        String   @id @default(uuid())
  childId   String
  faceId    String
  imageUrl  String
  createdAt DateTime @default(now())
  child     Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
}

model GuardianChild {
  id         String   @id @default(uuid())
  guardianId String
  childId    String
  child      Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  guardian   Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([guardianId, childId])
}

model ChildClassroom {
  id         String  @id @default(uuid())
  childId    String
  classId    String
  schoolYear String?
  child      Child   @relation(fields: [childId], references: [id], onDelete: Cascade)
  class      Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([childId, classId])
}

model Favorite {
  id         String   @id @default(uuid())
  guardianId String
  videoId    String
  createdAt  DateTime @default(now())
  guardian   Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([guardianId, videoId])
}

model GuardianClassroomSetting {
  id             String   @id @default(uuid())
  guardianId     String
  classId        String
  notifyNewVideo Boolean  @default(true)
  class          Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  guardian       Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([guardianId, classId])
}

model DeviceToken {
  id         String   @id @default(uuid())
  guardianId String
  token      String   @unique
  platform   String
  deviceName String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  guardian   Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)
}

model VideoFaceTag {
  id           String   @id @default(uuid())
  videoId      String
  childId      String?
  label        String?
  thumbnailUrl String?  @default("")
  startTime    Float
  endTime      Float
  confidence   Float
  isTentative  Boolean  @default(false)
  createdAt    DateTime @default(now())
  child        Child?   @relation(fields: [childId], references: [id])
  video        Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
}

model PrerollAd {
  id               String         @id @default(uuid())
  name             String
  videoUrl         String
  thumbnailUrl     String?
  linkUrl          String?
  ctaText          String?
  skipAfterSeconds Int            @default(5)
  priority         Int            @default(0)
  isActive         Boolean        @default(true)
  validFrom        DateTime?
  validTo          DateTime?
  schoolId         String?
  sponsorId        String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  impressions      AdImpression[]
  school           School?        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sponsor          Sponsor?       @relation(fields: [sponsorId], references: [id])

  @@index([schoolId])
  @@index([sponsorId])
  @@index([isActive])
}

model MidrollAd {
  id               String         @id @default(uuid())
  name             String
  videoUrl         String
  thumbnailUrl     String?
  linkUrl          String?
  ctaText          String?
  skipAfterSeconds Int            @default(5)
  triggerType      String         @default("percentage")
  triggerValue     Float?
  priority         Int            @default(0)
  isActive         Boolean        @default(true)
  validFrom        DateTime?
  validTo          DateTime?
  schoolId         String?
  sponsorId        String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  impressions      AdImpression[]
  school           School?        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sponsor          Sponsor?       @relation(fields: [sponsorId], references: [id])

  @@index([schoolId])
  @@index([sponsorId])
  @@index([isActive])
  @@index([triggerType])
}

model AdImpression {
  id          String     @id @default(uuid())
  adType      String
  prerollAdId String?
  midrollAdId String?
  sponsorId   String?
  schoolId    String?
  videoId     String?
  guardianId  String?
  sessionId   String?
  watchedFull Boolean    @default(false)
  skipped     Boolean    @default(false)
  skipTime    Float?
  watchTime   Float?
  adDuration  Float?
  reached25   Boolean    @default(false)
  reached50   Boolean    @default(false)
  reached75   Boolean    @default(false)
  reached100  Boolean    @default(false)
  clicked     Boolean    @default(false)
  deviceType  String?
  userAgent   String?
  hourOfDay   Int?
  dayOfWeek   Int?
  createdAt   DateTime   @default(now())
  midrollAd   MidrollAd? @relation(fields: [midrollAdId], references: [id], onDelete: Cascade)
  prerollAd   PrerollAd? @relation(fields: [prerollAdId], references: [id], onDelete: Cascade)

  @@index([adType])
  @@index([prerollAdId])
  @@index([midrollAdId])
  @@index([sponsorId])
  @@index([schoolId])
  @@index([videoId])
  @@index([guardianId])
  @@index([sessionId])
  @@index([createdAt])
  @@index([hourOfDay])
  @@index([dayOfWeek])
}

model AnalyticsEvent {
  id         String    @id @default(uuid())
  type       String
  schoolId   String?
  classId    String?
  guardianId String?
  metadata   Json?
  createdAt  DateTime  @default(now())
  class      Class?    @relation(fields: [classId], references: [id], onDelete: Cascade)
  guardian   Guardian? @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  school     School?   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([schoolId])
  @@index([classId])
  @@index([guardianId])
  @@index([createdAt])
}

model Announcement {
  id          String   @id @default(uuid())
  title       String
  body        String
  type        String   @default("info") // info, maintenance, video_new, event
  priority    String   @default("normal") // normal, high
  targetType  String   @default("all") // all, school, class, individual
  targetId    String?  // classId, schoolId, guardianId etc.
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  schoolId    String?
  school      School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([type])
  @@index([publishedAt])
}
